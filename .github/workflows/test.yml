name: Test

on:
  pull_request:
    branches: [master, main]
  push:
    branches: [master, main]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Verify directory structure
        run: |
          echo "Checking directory structure..."
          test -d .claude/agents || (echo "Missing .claude/agents/" && exit 1)
          test -d .claude/rules || (echo "Missing .claude/rules/" && exit 1)
          test -d .claude/skills || (echo "Missing .claude/skills/" && exit 1)
          test -f Makefile || (echo "Missing Makefile" && exit 1)
          test -f VERSION || (echo "Missing VERSION" && exit 1)
          echo "✅ Directory structure OK"

      - name: Count agents
        run: |
          COUNTS=$(bash scripts/count-agents.sh)
          echo "$COUNTS"
          CLAUDE_COUNT=$(echo "$COUNTS" | sed -E 's/.*claude:([0-9]+).*/\1/')
          COPILOT_COUNT=$(echo "$COUNTS" | sed -E 's/.*copilot:([0-9]+).*/\1/')
          EXPECTED_CLAUDE_COUNT=$(sed -nE 's/^<!-- AGENT_COUNTS: claude:([0-9]+) .*/\1/p' README.md)
          if [ -z "$EXPECTED_CLAUDE_COUNT" ]; then
            echo "❌ Unable to read expected Claude count from README.md AGENT_COUNTS template"
            exit 1
          fi
          MIN_CLAUDE_COUNT=$((EXPECTED_CLAUDE_COUNT * 80 / 100))
          if [ "$CLAUDE_COUNT" -lt "$MIN_CLAUDE_COUNT" ]; then
            echo "❌ Expected at least ${MIN_CLAUDE_COUNT} Claude agent files (80% of ${EXPECTED_CLAUDE_COUNT}), found $CLAUDE_COUNT"
            exit 1
          fi
          if [ "$COPILOT_COUNT" -lt 1 ]; then
            echo "❌ Expected at least 1 Copilot agent file, found $COPILOT_COUNT"
            exit 1
          fi
          echo "✅ Agent count OK"

      - name: Check README/AGENTS count template
        run: bash scripts/count-agents.sh --check-docs

      - name: Validate YAML frontmatter
        run: |
          ERRORS=0
          for file in $(find .claude/agents -name '*.md' ! -name 'CONSTITUTION.md' ! -name 'CommonValuesAndPrinciples.md' ! -name 'MICROSOFT_VALUES.md' ! -name 'SECURITY_FRAMEWORK_TEMPLATE.md' ! -name 'EXECUTION_DISCIPLINE.md'); do
            if ! head -1 "$file" | grep -q '^---$'; then
              echo "❌ Missing YAML frontmatter: $file"
              ERRORS=$((ERRORS + 1))
            fi
          done
          if [ "$ERRORS" -gt 0 ]; then
            echo "Found $ERRORS files with missing frontmatter"
            exit 1
          fi
          echo "✅ YAML frontmatter OK"

      - name: Check required fields
        run: |
          ERRORS=0
          for file in $(find .claude/agents -name '*.md' ! -name 'CONSTITUTION.md' ! -name 'CommonValuesAndPrinciples.md' ! -name 'MICROSOFT_VALUES.md' ! -name 'SECURITY_FRAMEWORK_TEMPLATE.md' ! -name 'EXECUTION_DISCIPLINE.md'); do
            if ! grep -q '^name:' "$file"; then
              echo "❌ Missing name field: $file"
              ERRORS=$((ERRORS + 1))
            fi
            if ! grep -q '^description:' "$file"; then
              echo "❌ Missing description field: $file"
              ERRORS=$((ERRORS + 1))
            fi
          done
          if [ "$ERRORS" -gt 0 ]; then
            exit 1
          fi
          echo "✅ Required fields OK"

      - name: Verify Constitution exists
        run: |
          test -f .claude/agents/core_utility/CONSTITUTION.md || (echo "Missing CONSTITUTION.md" && exit 1)
          grep -q 'Article VII' .claude/agents/core_utility/CONSTITUTION.md || (echo "Missing Article VII" && exit 1)
          grep -q 'NON-NEGOTIABLE' .claude/agents/core_utility/CONSTITUTION.md || (echo "Missing NON-NEGOTIABLE clause" && exit 1)
          echo "✅ Constitution OK"

      - name: Check for legacy files (should not exist)
        run: |
          if [ -d "claude-agents" ] || [ -d "claude-agenti" ] || [ -f "start.sh" ]; then
            echo "❌ Legacy files still present"
            exit 1
          fi
          echo "✅ No legacy files"

      - name: Run Makefile lint
        run: make lint
